<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>{{PAGE_TITLE}}</title>
    <link rel="stylesheet" href="{{BASE_PATH}}styles.css" />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/katex@0.16.27/dist/katex.min.css"
      integrity="sha384-Pu5+C18nP5dwykLJOhd2U4Xen7rjScHN/qusop27hdd2drI+lL5KvX7YntvT8yew"
      crossorigin="anonymous"
    />
  </head>
  <body data-chapter="{{CHAPTER_NUM}}">
    <button class="nav-toggle" aria-label="Toggle navigation" aria-expanded="false">&#9776;</button>
    <div class="nav-overlay"></div>
    <aside class="nav">{{SIDEBAR}}</aside>

    <article>{{CHAPTER_CONTENT}}</article>

    <script>
      // Get current chapter from data attribute
      const currentChapter = document.body.dataset.chapter;

      // Track visible sections and chapter header
      let visibleSections = new Set();
      let chapterHeaderVisible = false;

      function updateActiveSection() {
        // Remove all existing 'selected' classes
        document.querySelectorAll(".nav .selected").forEach((el) => {
          el.classList.remove("selected");
        });

        // Prioritize chapter header if visible
        if (chapterHeaderVisible || visibleSections.size == 0) {
          const chapterLink = document.querySelector(
            `.nav a.chapter[data-chapter="${currentChapter}"]`
          );
          if (chapterLink) {
            chapterLink.classList.add("selected");
          }
        } else {
          // Find the topmost visible section
          const sections = Array.from(
            document.querySelectorAll('section[id^="section-"]')
          );
          let currentSection = null;

          for (const section of sections) {
            if (visibleSections.has(section.id)) {
              currentSection = section;
              break;
            }
          }

          if (currentSection) {
            // Extract section number from id (e.g., "section-2" -> "2")
            const sectionNum = currentSection.id.replace("section-", "");
            const sectionLink = document.querySelector(
              `.nav a[data-chapter="${currentChapter}"][data-section="${sectionNum}"]`
            );
            if (sectionLink) {
              sectionLink.classList.add("selected");
            }
          }
        }
      }

      // Set up Intersection Observer to track section visibility
      const observer = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.target.id === "chapter-header") {
              chapterHeaderVisible = entry.isIntersecting;
            } else if (entry.isIntersecting) {
              visibleSections.add(entry.target.id);
            } else {
              visibleSections.delete(entry.target.id);
            }
          });
          updateActiveSection();
        },
        {
          rootMargin: "-100px 0px -50% 0px",
          threshold: [0, 0.1, 0.5, 1],
        }
      );

      // Observe all section elements and chapter header
      window.addEventListener("load", () => {
        // Observe chapter header
        const chapterHeader = document.querySelector("#chapter-header");
        if (chapterHeader) {
          observer.observe(chapterHeader);
        }

        // Observe all sections
        document
          .querySelectorAll('section[id^="section-"]')
          .forEach((section) => {
            observer.observe(section);
          });

        updateActiveSection();
      });

      {{AUTO_RELOAD_SCRIPT}}

      // Mobile navigation toggle
      const navToggle = document.querySelector(".nav-toggle");
      const navEl = document.querySelector(".nav");
      const navOverlay = document.querySelector(".nav-overlay");

      function openNav() {
        navEl.classList.add("open");
        navOverlay.classList.add("open");
        navToggle.setAttribute("aria-expanded", "true");
      }

      function closeNav() {
        navEl.classList.remove("open");
        navOverlay.classList.remove("open");
        navToggle.setAttribute("aria-expanded", "false");
      }

      navToggle.addEventListener("click", () => {
        if (navEl.classList.contains("open")) closeNav();
        else openNav();
      });
      navOverlay.addEventListener("click", closeNav);

      // Close nav when a link is clicked (navigate to section)
      navEl.querySelectorAll("a").forEach((link) => {
        link.addEventListener("click", () => {
          if (window.innerWidth <= 900) closeNav();
        });
      });
    </script>
  </body>
</html>
